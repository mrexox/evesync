#+TITLE: Спецификации

* moonwatchd
  - Следит за изменениями в директории /etc.
  - Есть конфигурационная директория /etc/sysmoon/.
  - Конфигурационный файл со списком директорий, подлежащих
    слежке /etc/sysmoon/watch.list
  - Все изменения посылаются демону 'moondatad.

* moondatad
  - При получения сообщения об изменении заносит их в файловую базу данных.
  - Один раз в день база данных сжимается и сохраняется по дате
    (если база содержит 100+ записей).
  - Если сохраниться не удаётся, пишется лог с ошибкой, отсылается письмо.

* moonapply (moon_apply)
  - Применяет изменения из файла-архива с ними.
  - Ругается, если что-то пошло не так.
  - Степени критических ошибок указываются в /etc/sysmoon/apply.conf

* Конфигурационные файлы /etc/sysmoon
** /etc/sysmoon/watch.list
   - /etc :: Директория, за файлами которой нужно следить
   - /etc/grub.d/40_custom :: Файл, за которым нужно следить
   - ^/etc/sysmoon :: Директория, файлы которой игнорируются
   - ^/etc/bashrc :: Файл, который нужно игнорировать
** /etc/sysmoon/apply.conf
   - conflicts:
     - no_package_available :: ignore|warn|notify|error
     - file_merge_conflict :: ignore|warn|notify|error
     - package_version_differ :: ignore|warn|notify|error
     - system_update_differ :: ignore|warn|notify|error
   - services:
     - restart_touched_services :: yes|no


#+TITLE: Псевдокод

* moonwatchd
  - read_config
  - subscribe_on_events
    - getting list of watched files
  - add_watched_files
  - start_awaiting_loop

* moondatad
  - read_config
  - subscribe_on_events
  - connect_to_database
  - create_timeout_events
    - on new filechange
    - [FUTURE] on new package change
    - [FUTURE] on new request for current state
  - start_waiting_loop
    - if got an event:
      - put to database
