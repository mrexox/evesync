#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/ipc'
require 'sysmoon/log'

Log.info("starting sysdatad...")

# Creating an IPC server to accept data
data_server = IPC.new(
  side: :server,
  port: :datad,
  protocol: :tcp
)

data_server.on_recieve do |message, client|
  Log.debug("Accepted message: #{message}")
  # ... put into database
  client.puts('ok')
end

thr = data_server.start

Signal.trap('TERM') do
  thr.exit
  data_server.stop
  exit(0)
end

Log.info("sysdatad started!")

begin
  loop do
    sleep 3600 # FIXME: 1 hour, rewrite better
    # zip db if needed, save backup
  end
rescue SignalException => e
  Log.warn("Signal got: #{e.signm}(#{signo})")
  thr.exit
  data_server.stop
  exit(0)
end
