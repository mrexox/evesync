#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/ipc'
require 'sysmoon/log'

Log.info("starting sysdatad...")

# Creating an IPC server to accept data
server = IPC.new(
  side: :server,
  port: :datad,
  protocol: :tcp
)

server.on_recieve do |message, client|
  Log.debug("Accepted message: #{message}")
  # ... put into database
  client.puts('ok')
end

thr = server.start

Signal.trap('TERM') do
#  Log.warn 'sysdatad killed...'
  thr.exit
  exit(0)
end

Signal.trap('SIGINT') do
#  Log.warn 'sysdatad interrupted...'
  thr.exit
  exit(0)
end


Log.info("sysdatad started!")
loop do
  sleep 3600 # FIXME: 1 hour, rewrite better
  # zip db if needed, save backup
end
