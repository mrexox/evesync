#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/ipc/server'
require 'sysmoon/log'
require 'sysmoon/database'

Sysmoon::Log.info('Database daemon starting...')

database = Sysmoon::Database.new

# Creating an IPC server to accept data
data_server = Sysmoon::IPC::Server.new(
  port: :sysdatad,
  proxy: database
).start

Signal.trap('TERM') do
  data_server.stop
  exit(0)
end

Sysmoon::Log.info('Database daemon started!')

begin
  loop do
    sleep 3600 # FIXME: 1 hour, rewrite better
    # zip db if needed, save backup
  end
rescue SignalException => e
  Sysmoon::Log.warn("Database daemon received signal: #{e.signm}(#{e.signo})")
  data_server.stop
  exit(0)
end
