#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/log'
require 'sysmoon/ipc'
require 'sysmoon/handlers'

Log.info('syshand starting...')

handler_server = IPC.new(
  side: :server,
  port: :hand,
  protocol: :tcp
)

handler = RemoteMessageHandler.new

handler_server.on_recieve do |message, client|
  Log.debug "Message recieved: #{message}"
  ans = handler.handle(message)
  client.puts(ans)
  Log.debug 'Message handled'
end

thr = handler_server.start

Signal.trap('TERM') do
  thr.exit
  handler_server.stop
  exit(0)
end

Log.info('syshand started!')

begin
  loop do
    sleep 3600 # FIXME: 1 hour, rewrite better
    # FIXME: know what to do
  end
rescue SignalException => e
  Log.warn("Signal got: #{e.signm}(#{signo})")
  thr.exit
  handler_server.stop
  exit(0)
end
