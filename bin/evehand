#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'evesync/log'
require 'evesync/ipc/server'
require 'evesync/handler'

Evesync::Log.info('Handle daemon starting...')

all_handler = Evesync::Handler.new

handler_server = Evesync::IPC::Server.new(
  port: :evehand,
  proxy: all_handler,
  ip: '*' # accept remote requests
).start

Evesync::Log.info('Handle daemon started!')

# Signal handling

Signal.trap('TERM') do
  handler_server.stop
  exit(0)
end

begin
  loop do
    sleep 3600 # FIXME: 1 hour, rewrite better
    # FIXME: know what to do
  end
rescue SignalException => e
  Evesync::Log.warn("Received signal: #{e.signm}(#{e.signo})")
  handler_server.stop
  exit(0)
end
