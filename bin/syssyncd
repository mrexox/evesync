#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/log'
require 'sysmoon/sync'
require 'sysmoon/config'

# Exiting if `auto_discover = false'
unless Sysmoon::Config[:sysmoond]['auto_discover']
  Sysmoon::Log.info('Synchronizing not required')
  exit(0)
end

Sysmoon::Log.info('Synchronizing daemon starting...')

sync = Sysmoon::Sync.new

Signal.trap('TERM') do
  exit(0)
end

Sysmoon::Log.info('Synchronizing daemon started!')

few_seconds = Sysmoon::Config[:sysmoond]['discover_timeout'].to_i

sync.discover                   # discovering nodes
sleep 3                         # giving 3 seconds to complete

begin
  loop do
    sync.synchronize                # updating this node
    sleep few_seconds           # ... in some interval
  end
rescue SignalException
  exit(0)
end
