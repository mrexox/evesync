#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/log'
require 'sysmoon/ipc/server'
require 'sysmoon/trigger'
require 'sysmoon/watcher'

Sysmoon::Log.info 'sysmoond starting...'

queue = Queue.new
trigger = Sysmoon::Trigger.new(queue)
watcher = Sysmoon::Watcher.new(queue)

[trigger, watcher].each(&:start)

sysmoon_server = Sysmoon::IPC::Server.new(
  port: :sysmoond,
  proxy: trigger
).start

Sysmoon::Log.info 'sysmoond started!'

# Signal handling

Signal.trap('SIGINT') do
  [watcher, trigger].each(&:stop)
  sysmoon_server.stop
  exit(0)
end

begin
  loop do
    sleep 100
    # FIXME: know what to do
  end
rescue SignalException => e
  Sysmoon::Log.warn("Signal got: #{e.signm}(#{e.signo})")
  watcher.stop
  sysmoon_server.stop
  exit(0)
end
