#!/usr/bin/env ruby
# -*- mode: ruby -*-

require 'sysmoon/distro'
require 'sysmoon/handlers'
require 'sysmoon/log'

Log.info 'sysmoond starting...'

queue = Queue.new

threads = []

threads << Thread.new(queue) { |q|
  Sysmoon::MessageHandler.new(q).run
}

threads << Thread.new(queue) { |q|
  PackageWatcher.new(q).run
}

Log.info 'sysmoond started!'

Signal.trap('SIGINT') do
  threads.each(&:exit)
  exit(0)
end

begin
  loop do
    sleep 100
  end
rescue SignalException => e
  Log.warn("Signal got: #{e.signm}(#{signo})")
  threads.each(&:exit)
  exit(0)
end
